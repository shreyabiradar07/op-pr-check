name: Sync Kruize Versions

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout kruize-operator repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Fetch Kruize Autotune version from master branch
        id: fetch-autotune-version
        run: |
          # Fetch the pom.xml from kruize/autotune master branch
          KRUIZE_VERSION=$(curl -s https://raw.githubusercontent.com/kruize/autotune/master/pom.xml | grep -oP '<version>\K[^<]+' | head -1)
          
          if [ -z "$KRUIZE_VERSION" ]; then
            echo "Failed to fetch Kruize Autotune version from pom.xml"
            exit 1
          fi
          
          echo "kruize_version=$KRUIZE_VERSION" >> $GITHUB_OUTPUT
          echo "Fetched Kruize Autotune version: $KRUIZE_VERSION"

      - name: Fetch Kruize UI version from master branch
        id: fetch-ui-version
        run: |
          # Fetch the package.json from kruize/kruize-ui master branch
          UI_VERSION=$(curl -s https://raw.githubusercontent.com/kruize/kruize-ui/main/package.json | jq -r '.version')
          
          if [ -z "$UI_VERSION" ] || [ "$UI_VERSION" = "null" ]; then
            echo "Failed to fetch Kruize UI version from package.json"
            exit 1
          fi
          
          echo "ui_version=$UI_VERSION" >> $GITHUB_OUTPUT
          echo "Fetched Kruize UI version: $UI_VERSION"

      - name: Check Quay.io for Autotune image tag availability
        id: check-autotune-image
        run: |
          KRUIZE_VERSION="${{ steps.fetch-autotune-version.outputs.kruize_version }}"
          
          # Check if the image tag exists on quay.io
          IMAGE_URL="https://quay.io/api/v1/repository/kruize/autotune_operator/tag/?specificTag=${KRUIZE_VERSION}"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            # Check if the tag actually exists in the response
            TAG_EXISTS=$(curl -s "$IMAGE_URL" | jq -r '.tags | length')
            if [ "$TAG_EXISTS" -gt 0 ]; then
              echo "image_available=true" >> $GITHUB_OUTPUT
              echo "Autotune image tag $KRUIZE_VERSION is available on quay.io"
            else
              echo "image_available=false" >> $GITHUB_OUTPUT
              echo "Autotune image tag $KRUIZE_VERSION not found on quay.io"
            fi
          else
            echo "image_available=false" >> $GITHUB_OUTPUT
            echo "Failed to check Autotune image availability (HTTP $HTTP_CODE)"
          fi

      - name: Check Quay.io for UI image tag availability
        id: check-ui-image
        run: |
          UI_VERSION="${{ steps.fetch-ui-version.outputs.ui_version }}"
          
          # Check if the image tag exists on quay.io
          IMAGE_URL="https://quay.io/api/v1/repository/kruize/kruize-ui/tag/?specificTag=${UI_VERSION}"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            # Check if the tag actually exists in the response
            TAG_EXISTS=$(curl -s "$IMAGE_URL" | jq -r '.tags | length')
            if [ "$TAG_EXISTS" -gt 0 ]; then
              echo "image_available=true" >> $GITHUB_OUTPUT
              echo "UI image tag $UI_VERSION is available on quay.io"
            else
              echo "image_available=false" >> $GITHUB_OUTPUT
              echo "UI image tag $UI_VERSION not found on quay.io"
            fi
          else
            echo "image_available=false" >> $GITHUB_OUTPUT
            echo "Failed to check UI image availability (HTTP $HTTP_CODE)"
          fi

      - name: Get current versions from constants
        id: current-versions
        run: |
          CURRENT_AUTOTUNE_VERSION=$(grep -oP 'defaultAutotuneImageTag = "\K[^"]+' internal/constants/kruize_images.go)
          CURRENT_UI_VERSION=$(grep -oP 'defaultUIImageTag = "\K[^"]+' internal/constants/kruize_images.go)
          
          echo "current_autotune_version=$CURRENT_AUTOTUNE_VERSION" >> $GITHUB_OUTPUT
          echo "current_ui_version=$CURRENT_UI_VERSION" >> $GITHUB_OUTPUT
          echo "Current Autotune version in constants: $CURRENT_AUTOTUNE_VERSION"
          echo "Current UI version in constants: $CURRENT_UI_VERSION"

      - name: Compare versions and determine updates needed
        id: update-check
        run: |
          KRUIZE_VERSION="${{ steps.fetch-autotune-version.outputs.kruize_version }}"
          UI_VERSION="${{ steps.fetch-ui-version.outputs.ui_version }}"
          CURRENT_AUTOTUNE_VERSION="${{ steps.current-versions.outputs.current_autotune_version }}"
          CURRENT_UI_VERSION="${{ steps.current-versions.outputs.current_ui_version }}"
          AUTOTUNE_IMAGE_AVAILABLE="${{ steps.check-autotune-image.outputs.image_available }}"
          UI_IMAGE_AVAILABLE="${{ steps.check-ui-image.outputs.image_available }}"
          
          NEEDS_AUTOTUNE_UPDATE=false
          NEEDS_UI_UPDATE=false
          
          # Check Autotune version
          if [ "$AUTOTUNE_IMAGE_AVAILABLE" = "true" ] && [ "$KRUIZE_VERSION" != "$CURRENT_AUTOTUNE_VERSION" ]; then
            NEEDS_AUTOTUNE_UPDATE=true
            echo "Autotune version mismatch detected: $CURRENT_AUTOTUNE_VERSION -> $KRUIZE_VERSION"
          else
            echo "Autotune version check: No update needed or image not available"
          fi
          
          # Check UI version
          if [ "$UI_IMAGE_AVAILABLE" = "true" ] && [ "$UI_VERSION" != "$CURRENT_UI_VERSION" ]; then
            NEEDS_UI_UPDATE=true
            echo "UI version mismatch detected: $CURRENT_UI_VERSION -> $UI_VERSION"
          else
            echo "UI version check: No update needed or image not available"
          fi
          
          # Determine if any update is needed
          if [ "$NEEDS_AUTOTUNE_UPDATE" = "true" ] || [ "$NEEDS_UI_UPDATE" = "true" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "needs_autotune_update=$NEEDS_AUTOTUNE_UPDATE" >> $GITHUB_OUTPUT
            echo "needs_ui_update=$NEEDS_UI_UPDATE" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "needs_autotune_update=false" >> $GITHUB_OUTPUT
            echo "needs_ui_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Update kruize_images.go and sample YAML
        if: steps.update-check.outputs.needs_update == 'true'
        run: |
          KRUIZE_VERSION="${{ steps.fetch-autotune-version.outputs.kruize_version }}"
          UI_VERSION="${{ steps.fetch-ui-version.outputs.ui_version }}"
          NEEDS_AUTOTUNE_UPDATE="${{ steps.update-check.outputs.needs_autotune_update }}"
          NEEDS_UI_UPDATE="${{ steps.update-check.outputs.needs_ui_update }}"
          
          # Update Autotune version if needed
          if [ "$NEEDS_AUTOTUNE_UPDATE" = "true" ]; then
            sed -i "s/defaultAutotuneImageTag = \"[^\"]*\"/defaultAutotuneImageTag = \"$KRUIZE_VERSION\"/" internal/constants/kruize_images.go
            sed -i "s|autotune_image: \"quay.io/kruize/autotune_operator:[^\"]*\"|autotune_image: \"quay.io/kruize/autotune_operator:$KRUIZE_VERSION\"|" config/samples/v1alpha1_kruize.yaml
            echo "Updated Autotune version to $KRUIZE_VERSION"
          fi
          
          # Update UI version if needed
          if [ "$NEEDS_UI_UPDATE" = "true" ]; then
            sed -i "s/defaultUIImageTag = \"[^\"]*\"/defaultUIImageTag = \"$UI_VERSION\"/" internal/constants/kruize_images.go
            sed -i "s|autotune_ui_image: \"quay.io/kruize/kruize-ui:[^\"]*\"|autotune_ui_image: \"quay.io/kruize/kruize-ui:$UI_VERSION\"|" config/samples/v1alpha1_kruize.yaml
            echo "Updated UI version to $UI_VERSION"
          fi

      - name: Create Pull Request
        if: steps.update-check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update Kruize versions (Autotune: ${{ steps.fetch-autotune-version.outputs.kruize_version }}, UI: ${{ steps.fetch-ui-version.outputs.ui_version }})"
          title: "chore: update Kruize image versions"
          body: |
            ## Automated Version Update
            
            This PR automatically updates Kruize image versions based on changes detected in the upstream repositories.
            
            ### Changes
            
            ${{ steps.update-check.outputs.needs_autotune_update == 'true' && format('#### Kruize Autotune
            - Updated `defaultAutotuneImageTag` in `internal/constants/kruize_images.go` from `{0}` to `{1}`
            - Updated `autotune_image` in `config/samples/v1alpha1_kruize.yaml` to `quay.io/kruize/autotune_operator:{1}`
            - Image verified to be available on quay.io: `quay.io/kruize/autotune_operator:{1}`
            
            **Source:** [kruize/autotune pom.xml](https://github.com/kruize/autotune/blob/master/pom.xml)
            
            ', steps.current-versions.outputs.current_autotune_version, steps.fetch-autotune-version.outputs.kruize_version) || '' }}
            
            ${{ steps.update-check.outputs.needs_ui_update == 'true' && format('#### Kruize UI
            - Updated `defaultUIImageTag` in `internal/constants/kruize_images.go` from `{0}` to `{1}`
            - Updated `autotune_ui_image` in `config/samples/v1alpha1_kruize.yaml` to `quay.io/kruize/kruize-ui:{1}`
            - Image verified to be available on quay.io: `quay.io/kruize/kruize-ui:{1}`
            
            **Source:** [kruize/kruize-ui package.json](https://github.com/kruize/kruize-ui/blob/main/package.json)
            
            ', steps.current-versions.outputs.current_ui_version, steps.fetch-ui-version.outputs.ui_version) || '' }}
            
            ### Verification
            - [x] Versions extracted from source repositories
            - [x] Image tags verified on quay.io
            - [x] Tests passed
            
            ### Image Registries
            - Autotune: https://quay.io/repository/kruize/autotune_operator
            - UI: https://quay.io/repository/kruize/kruize-ui
            
            **Note:** This is an automated PR. Please review the changes and merge if appropriate.
          branch: automated/update-kruize-versions-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            dependencies
            kruize-version-update

      - name: Summary
        if: always()
        run: |
          echo "## Kruize Version Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Autotune" >> $GITHUB_STEP_SUMMARY
          echo "- **Version (pom.xml):** ${{ steps.fetch-autotune-version.outputs.kruize_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version (constants):** ${{ steps.current-versions.outputs.current_autotune_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Available:** ${{ steps.check-autotune-image.outputs.image_available }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Needed:** ${{ steps.update-check.outputs.needs_autotune_update }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### UI" >> $GITHUB_STEP_SUMMARY
          echo "- **Version (package.json):** ${{ steps.fetch-ui-version.outputs.ui_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version (constants):** ${{ steps.current-versions.outputs.current_ui_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Available:** ${{ steps.check-ui-image.outputs.image_available }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Needed:** ${{ steps.update-check.outputs.needs_ui_update }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Overall" >> $GITHUB_STEP_SUMMARY
          echo "- **Any Update Needed:** ${{ steps.update-check.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARY

