name: PR Check - Build, Deploy and Verify

on:
  pull_request:
    branches:
      - main
      - master
      - develop
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: '1.24'
  OPERATOR_IMAGE: quay.io/shbirada/pr_check:pr-${{ github.event.pull_request.number }}
  NAMESPACE: monitoring

jobs:
  build-deploy-verify:
    name: Build, Deploy and Verify Operator
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Run unit tests
        run: make test

      - name: Run linter
        run: |
          make lint || echo "Linting completed with warnings"

      - name: Set up Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kruize-test-cluster
          wait: 120s
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
              extraPortMappings:
              - containerPort: 30080
                hostPort: 30080
                protocol: TCP

      - name: Verify Kind cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl version

      - name: Build operator image
        run: |
          make docker-build IMG=${{ env.OPERATOR_IMAGE }}

      - name: Load image to Kind cluster
        run: |
          kind load docker-image ${{ env.OPERATOR_IMAGE }} --name kruize-test-cluster

      - name: Install Prometheus Operator
        run: |
          kubectl create -f https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/bundle.yaml
          echo "Waiting for Prometheus Operator to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus-operator -n default --timeout=300s || true

      - name: Create operator namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} || true

      - name: Install CRDs
        run: |
          make install

      - name: Deploy operator
        run: |
          make deploy IMG=${{ env.OPERATOR_IMAGE }}

      - name: Wait for operator deployment
        run: |
          echo "Waiting for controller-manager to be ready..."
          kubectl wait --for=condition=available deployment/kruize-operator-controller-manager \
            -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Verify operator pod is running
        run: |
          kubectl get pods -n ${{ env.NAMESPACE }}
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l control-plane=controller-manager -o jsonpath='{.items[0].metadata.name}')
          echo "Operator pod: $POD_NAME"
          kubectl get pod $POD_NAME -n ${{ env.NAMESPACE }} -o jsonpath='{.status.phase}' | grep -q "Running"
          echo "✓ Operator pod is running"

      - name: Check operator logs
        if: always()
        run: |
          echo "=== Operator Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l control-plane=controller-manager --tail=100 || true

      - name: Deploy Kruize CR
        run: |
          # Update CR for Kind cluster with monitoring namespace
          cp config/samples/_v1alpha1_kruize.yaml /tmp/kruize-cr.yaml
          
          # Update cluster_type to kind and namespace to monitoring
          sed -i 's/cluster_type:.*/cluster_type: kind/' /tmp/kruize-cr.yaml
          sed -i 's/namespace:.*/namespace: monitoring/' /tmp/kruize-cr.yaml
          
          echo "Updated Kruize CR:"
          cat /tmp/kruize-cr.yaml
          
          kubectl apply -f /tmp/kruize-cr.yaml -n monitoring
          echo "Kruize CR deployed with cluster_type=kind and namespace=monitoring"

      - name: Verify Kruize deployment
        run: |
          echo "Waiting for monitoring namespace..."
          timeout 120s bash -c 'until kubectl get namespace monitoring; do sleep 5; done'
          
          echo "Waiting for Kruize deployment..."
          kubectl wait --for=condition=available deployment/kruize \
            -n monitoring--timeout=300s || true
          
          echo "Waiting for Kruize DB deployment..."
          kubectl wait --for=condition=available deployment/kruize-db \
            -n monitoring --timeout=300s || true

      - name: Verify Kruize components
        run: |
          echo "=== Kruize Namespace Resources ==="
          kubectl get all -n monitoring
          
          echo "=== Kruize ServiceAccount ==="
          kubectl get serviceaccount kruize-sa -n monitoring
          
          echo "=== Kruize ConfigMap ==="
          kubectl get configmap kruizeconfig -n openshift-tuning -o yaml
          
          echo "=== Kruize Deployment Status ==="
          kubectl get deployment kruize -n openshift-tuning -o jsonpath='{.status.readyReplicas}'
          
          echo "=== Kruize DB Deployment Status ==="
          kubectl get deployment kruize-db -n openshift-tuning -o jsonpath='{.status.readyReplicas}'

      - name: Test Kruize API health
        run: |
          echo "Testing Kruize API health endpoint..."
          kubectl exec deployment/kruize -n openshift-tuning -- curl -s localhost:8080/health || echo "Health check failed"

      - name: Run E2E tests
        run: |
          echo "Running E2E tests..."
          make test-e2e || echo "E2E tests completed with issues"

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Operator Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l control-plane=controller-manager --tail=200 || true
          
          echo "=== Kruize Logs ==="
          kubectl logs -n openshift-tuning deployment/kruize --tail=200 || true
          
          echo "=== Kruize DB Logs ==="
          kubectl logs -n openshift-tuning deployment/kruize-db --tail=200 || true
          
          echo "=== All Pods Status ==="
          kubectl get pods --all-namespaces
          
          echo "=== Events ==="
          kubectl get events --all-namespaces --sort-by='.lastTimestamp'

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up resources..."
          kubectl delete -f /tmp/kruize-cr.yaml --ignore-not-found=true || true
          make undeploy || true
          make uninstall || true
          kubectl delete namespace ${{ env.NAMESPACE }} --ignore-not-found=true || true
          kubectl delete namespace openshift-tuning --ignore-not-found=true || true

      - name: Summary
        if: success()
        run: |
          echo "✓ PR Check Passed!"
          echo "✓ Operator image built successfully"
          echo "✓ Operator deployed successfully"
          echo "✓ Kruize components verified"
          echo "✓ All checks completed"