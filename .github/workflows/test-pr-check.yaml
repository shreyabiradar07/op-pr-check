name: PR Check - Build, Deploy and Verify

on:
  pull_request:
    branches:
      - main
      - mvp_demo
    types: [opened, synchronize, reopened]

env:
  GO_VERSION: '1.24'
  OPERATOR_IMAGE: quay.io/shbirada/pr_check:pr-${{ github.event.pull_request.number }}
  NAMESPACE: monitoring

jobs:
  build-deploy-verify:
    name: Build, Deploy and Verify Operator
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Create Kind config
        run: |
          cat > kind-config.yaml <<EOF
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 30080
              hostPort: 30080
              protocol: TCP
          EOF

      - name: Set up Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kruize-test-cluster
          wait: 120s
          config: kind-config.yaml

      - name: Verify Kind cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl version

      - name: Build operator image
        run: |
          make docker-build IMG=${{ env.OPERATOR_IMAGE }}

      - name: Load image to Kind cluster
        run: |
          kind load docker-image ${{ env.OPERATOR_IMAGE }} --name kruize-test-cluster

      - name: Create operator namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} || true

      - name: Install Prometheus with cadvisor
        run: |
          PROMETHEUS_TAG="v0.13.0"
          PROMETHEUS_NS="monitoring"
          
          echo "Info: Checking if Prometheus is already installed..."
          if kubectl get pods -n ${PROMETHEUS_NS} 2>/dev/null | grep -q "prometheus-k8s-1"; then
            echo "Prometheus is already installed and running."
          else
            echo "Info: Installing cadvisor and Prometheus"
          
            # Create downloads directory
            mkdir -p /tmp/kind_downloads
            cd /tmp/kind_downloads
          
            # Install cadvisor
            echo "Info: Downloading cadvisor git"
            git clone https://github.com/google/cadvisor.git 2>/dev/null || echo "cadvisor already cloned"
            cd cadvisor/deploy/kubernetes/base
            echo "Info: Installing cadvisor"
            kubectl kustomize . | kubectl apply -f-
            cd /tmp/kind_downloads
          
            # Install Prometheus
            echo "Info: Downloading prometheus git release - ${PROMETHEUS_TAG}"
            git clone -b ${PROMETHEUS_TAG} https://github.com/coreos/kube-prometheus.git 2>/dev/null || echo "kube-prometheus already cloned"
            cd kube-prometheus/manifests
          
            echo "Info: Installing prometheus setup"
            kubectl apply -f setup --server-side
          
            echo "Info: Installing prometheus manifests"
            kubectl apply -f . --server-side
          
            # Wait for prometheus-k8s-1 pod to be spawned
            echo -n "Info: Waiting for Prometheus Pods to get spawned..."
            for i in {1..60}; do
              if kubectl get pods -n ${PROMETHEUS_NS} 2>/dev/null | grep -q "prometheus-k8s-1"; then
                echo "done"
                break
              fi
              echo -n "."
              sleep 5
            done
          
            echo "Info: Verifying Prometheus installation..."
            kubectl get statefulset prometheus-k8s -n ${PROMETHEUS_NS}
            kubectl get svc prometheus-k8s -n ${PROMETHEUS_NS}
            kubectl get pods -n ${PROMETHEUS_NS} -l app.kubernetes.io/name=prometheus
          
            echo "Info: Prometheus installation completed successfully"
          fi

      - name: Install CRDs
        run: |
          make install

      - name: Reduce operator resource requests for Kind
        run: |
          echo "Reducing CPU/memory requests for resource-constrained Kind cluster..."
          
          # Reduce manager container resources
          sed -i 's/cpu: 10m/cpu: 1m/' config/manager/manager.yaml
          sed -i 's/memory: 64Mi/memory: 32Mi/' config/manager/manager.yaml
          
          # Reduce kube-rbac-proxy resources
          sed -i 's/cpu: 5m/cpu: 1m/' config/default/manager_auth_proxy_patch.yaml
          sed -i 's/memory: 64Mi/memory: 32Mi/' config/default/manager_auth_proxy_patch.yaml
          
          echo "Updated resource requests:"
          grep -A 3 "requests:" config/manager/manager.yaml
          grep -A 3 "requests:" config/default/manager_auth_proxy_patch.yaml

      - name: Deploy operator
        run: |
          make deploy IMG=${{ env.OPERATOR_IMAGE }} OVERLAY=local

      - name: Verify operator pod is running
        run: |
          echo "=== Waiting for operator deployment ==="
          kubectl wait --for=condition=available deployment/kruize-operator-controller-manager -n monitoring --timeout=60s || {
            echo "Warning: operator deployment may not be fully ready"
            kubectl get deployment kruize-operator-controller-manager -n monitoring
          }
          
          echo "=== Operator Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -l control-plane=controller-manager
          
          echo "=== Operator Pod Description ==="
          kubectl describe pods -n ${{ env.NAMESPACE }} -l control-plane=controller-manager
          
          echo "✓ Operator pod is running"

      - name: Deploy Kruize CR
        run: |
          # Update CR for Kind cluster with monitoring namespace
          cp config/samples/v1alpha1_kruize.yaml /tmp/kruize-cr.yaml
          
          # Update cluster_type to kind and namespace to monitoring (preserve quotes)
          sed -i 's/cluster_type: .*/cluster_type: "kind"/' /tmp/kruize-cr.yaml
          sed -i 's/namespace: .*/namespace: "monitoring"/' /tmp/kruize-cr.yaml
          
          echo "Updated Kruize CR:"
          cat /tmp/kruize-cr.yaml
          
          kubectl apply -f /tmp/kruize-cr.yaml -n monitoring
          echo "Kruize CR deployed with cluster_type=kind and namespace=monitoring"
          
          echo "Waiting for reconciliation to start..."
          sleep 10
          
          echo "=== Operator Logs After CR Deployment ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l control-plane=controller-manager || true

      - name: Wait for Kruize deployments to be created
        run: |
          echo "Waiting for Kruize deployments to be created by operator..."
          
          # Wait for both deployments to exist (check every 2 seconds, max 60 seconds)
          echo -n "Waiting for deployments..."
          for i in {1..30}; do
            if kubectl get deployment kruize -n monitoring &>/dev/null && \
               kubectl get deployment kruize-db-deployment -n monitoring &>/dev/null; then
              echo "done"
              break
            fi
            echo -n "."
            sleep 2
          done
          
          # Wait for both deployments to be ready (60 seconds max)
          kubectl wait --for=condition=available deployment/kruize deployment/kruize-db-deployment -n monitoring --timeout=60s || {
            echo "Warning: deployments may not be fully ready"
            kubectl get deployments -n monitoring
          }

      - name: Verify Kruize deployment
        run: |
          echo "=== Monitoring Namespace ==="
          kubectl get namespace monitoring
          
          echo "=== Kruize Deployments ==="
          kubectl get deployments/kruize -n monitoring
          kubectl get deployments/kruize-db-deployment -n monitoring

      - name: Verify Kruize components
        run: |
          
          echo "=== Kruize ServiceAccount ==="
          kubectl get serviceaccount default -n monitoring
          
          echo "=== Kruize ConfigMap ==="
          kubectl get configmap kruizeconfig -n monitoring -o yaml
          
          echo "=== Kruize Deployment Status ==="
          kubectl get deployment kruize -n monitoring -o jsonpath='{.status.readyReplicas}'
          
          echo "=== Kruize DB Deployment Status ==="
          kubectl get deployment kruize-db-deployment -n monitoring -o jsonpath='{.status.readyReplicas}'

      - name: Check Kruize pod status and logs
        run: |
          echo "=== Kruize Pod Status ==="
          kubectl get pods -n monitoring -l app=kruize
          
          echo "=== Kruize Pod Logs ==="
          kubectl logs -n monitoring deployment/kruize || true

      - name: Test Kruize API health
        run: |
          echo "Testing Kruize API health endpoint..."
          kubectl exec deployment/kruize -n monitoring -- curl -s localhost:8080/health || echo "Health check failed"

      - name: Test Kruize datasources API
        run: |
          echo "Testing Kruize datasources API endpoint..."
          echo "=== /datasources Output ==="
          kubectl exec deployment/kruize -n monitoring -- curl -s localhost:8080/datasources || echo "Datasources API call failed"
          echo ""
          
          echo "=== Kruize Logs After Datasources Call ==="
          kubectl logs -n monitoring deployment/kruize --tail=50 || true

      - name: Collect and save logs
        if: always()
        run: |
          echo "Creating results directory..."
          mkdir -p results
          
          echo "=== Collecting Operator Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l control-plane=controller-manager --tail=500 > results/operator-logs.txt 2>&1 || echo "Failed to collect operator logs" > results/operator-logs.txt
          
          echo "=== Collecting Kruize Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} deployment/kruize --tail=500 > results/kruize-logs.txt 2>&1 || echo "Failed to collect kruize logs" > results/kruize-logs.txt
          
          echo "=== Collecting Kruize DB Logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} deployment/kruize-db-deployment --tail=500 > results/kruize-db-logs.txt 2>&1 || echo "Failed to collect kruize-db logs" > results/kruize-db-logs.txt
          
          echo "=== Collecting Pod Descriptions ==="
          kubectl describe pods -n ${{ env.NAMESPACE }} > results/pod-descriptions.txt 2>&1 || true
          
          echo "=== Collecting Deployment Status ==="
          kubectl get deployments -n ${{ env.NAMESPACE }} -o yaml > results/deployments.yaml 2>&1 || true
          
          echo "=== Collecting Events ==="
          kubectl get events -n ${{ env.NAMESPACE }} --sort-by='.lastTimestamp' > results/events.txt 2>&1 || true
          
          echo "Logs collected in results/ directory"
          ls -lh results/

      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-check-logs-${{ github.event.pull_request.number }}
          path: results/
          retention-days: 1

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up resources..."
          
          # Delete Kruize CR first
          echo "Deleting Kruize CR..."
          kubectl delete -f /tmp/kruize-cr.yaml -n ${{ env.NAMESPACE }} --ignore-not-found=true 2>/dev/null || true
          
          # Undeploy operator (this also removes CRDs)
          echo "Undeploying operator..."
          make undeploy OVERLAY=local 2>/dev/null || true
          
          # Delete namespace (will cascade delete all resources)
          echo "Deleting namespace..."
          kubectl delete namespace ${{ env.NAMESPACE }} --ignore-not-found=true --timeout=60s 2>/dev/null || true
          
          echo "Cleanup completed"

      - name: Summary
        if: success()
        run: |
          echo "✓ PR Check Passed!"
          echo "✓ Operator image built successfully"
          echo "✓ Operator deployed successfully"
          echo "✓ Kruize components verified"
          echo "✓ All checks completed"