name: Update OpenShift Versions

on:
  schedule:
    # Run weekly on Monday at 03:30 UTC (9:00 AM IST)
    - cron: '30 3 * * 1'
  workflow_dispatch:
    inputs:
      min_version:
        description: 'Minimum OpenShift version (e.g., v4.10)'
        required: false
        type: string
      max_version:
        description: 'Maximum OpenShift version (e.g., v4.20)'
        required: false
        type: string

permissions:
  contents: read
  issues: write

jobs:
  update-openshift-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch latest OpenShift versions
        id: fetch-versions
        run: |
          # Fetch OpenShift release information from Red Hat's Cincinnati API
          
          # For manual trigger with custom versions
          if [ -n "${{ github.event.inputs.min_version }}" ] && [ -n "${{ github.event.inputs.max_version }}" ]; then
            MIN_VERSION="${{ github.event.inputs.min_version }}"
            MAX_VERSION="${{ github.event.inputs.max_version }}"
            echo "Using manual versions: $MIN_VERSION to $MAX_VERSION"
          else
            echo "Fetching latest OpenShift versions from Cincinnati API..."
          
            # Get current versions from annotations.yaml
            CURRENT_RANGE=$(grep "com.redhat.openshift.versions:" bundle/metadata/annotations.yaml | cut -d'"' -f2)
            echo "Current range: $CURRENT_RANGE"
          
            # Extract current min and max
            CURRENT_MIN=$(echo $CURRENT_RANGE | cut -d'-' -f1)
            CURRENT_MAX=$(echo $CURRENT_RANGE | cut -d'-' -f2)
          
            # Query OpenShift Cincinnati API for stable channel releases
            # Cincinnati is Red Hat's update service for OpenShift
            CINCINNATI_URL="https://api.openshift.com/api/upgrades_info/v1/graph"
          
            echo "Detecting latest OpenShift version..."
          
            # Method 1: Try to fetch from Red Hat's mirror list (most reliable)
            echo "Attempting to fetch from Red Hat mirror..."
            LATEST_MINOR=$(curl -s "https://mirror.openshift.com/pub/openshift-v4/clients/ocp/" 2>/dev/null | \
              grep -oP 'stable-4\.\d+' | \
              sed 's/stable-4\.//' | \
              sort -n | \
              tail -1)
          
            if [ -n "$LATEST_MINOR" ]; then
              echo "âœ“ Latest version from mirror: 4.${LATEST_MINOR}"
            else
              # Method 2: Try Cincinnati API with a high version and work backwards
              echo "Mirror method failed, trying Cincinnati API..."
              for MINOR in 25 24 23 22 21 20 19 18 17 16; do
                if curl -s -f "${CINCINNATI_URL}?channel=stable-4.${MINOR}" 2>/dev/null | jq -e '.nodes[0]' >/dev/null 2>&1; then
                  LATEST_MINOR=$MINOR
                  echo "âœ“ Latest version from Cincinnati: 4.${LATEST_MINOR}"
                  break
                fi
              done
            fi
          
            if [ -z "$LATEST_MINOR" ]; then
              echo "ERROR: Could not detect latest OpenShift version from any source"
              echo "Skipping update check - no changes will be made"
              echo "min_version=" >> $GITHUB_OUTPUT
              echo "max_version=" >> $GITHUB_OUTPUT
              echo "new_range=" >> $GITHUB_OUTPUT
              exit 0
            fi
          
            # Calculate minimum version (6 versions back from latest)
            MIN_MINOR=$((LATEST_MINOR - 5))
          
            echo "Version range: v4.${MIN_MINOR} to v4.${LATEST_MINOR}"
          
            MIN_VERSION="v4.${MIN_MINOR}"
            MAX_VERSION="v4.${LATEST_MINOR}"
          
            # Fetch all versions from the range for validation
            echo "Fetching versions from stable channels..."
            ALL_VERSIONS=""
            for MINOR in $(seq $LATEST_MINOR -1 $MIN_MINOR); do
              CHANNEL="stable-4.${MINOR}"
              echo "Checking channel: $CHANNEL"
          
              CHANNEL_VERSIONS=$(curl -s -f -H 'Accept: application/json' "${CINCINNATI_URL}?channel=${CHANNEL}" 2>/dev/null | \
                jq -r '.nodes[]?.version' 2>/dev/null | \
                grep -E '^4\.[0-9]+\.[0-9]+$' 2>/dev/null || true)
          
              if [ -n "$CHANNEL_VERSIONS" ]; then
                ALL_VERSIONS="${ALL_VERSIONS}${CHANNEL_VERSIONS}"$'\n'
              fi
            done
          
            # Display detected versions
            VERSIONS=$(echo "$ALL_VERSIONS" | grep -E '^4\.[0-9]+\.[0-9]+$' | sort -uV)
          
            if [ -n "$VERSIONS" ]; then
              echo "Available OpenShift versions detected:"
              echo "$VERSIONS" | head -10
              echo "..."
              echo "Total versions found: $(echo "$VERSIONS" | wc -l)"
            else
              echo "Warning: No versions detected from Cincinnati API"
            fi
          fi
          
          echo "Determined version range: $MIN_VERSION-$MAX_VERSION"
          echo "min_version=$MIN_VERSION" >> $GITHUB_OUTPUT
          echo "max_version=$MAX_VERSION" >> $GITHUB_OUTPUT
          echo "new_range=$MIN_VERSION-$MAX_VERSION" >> $GITHUB_OUTPUT

      - name: Update annotations.yaml
        id: update-file
        run: |
          NEW_RANGE="${{ steps.fetch-versions.outputs.new_range }}"
          CURRENT_RANGE=$(grep "com.redhat.openshift.versions:" bundle/metadata/annotations.yaml | cut -d'"' -f2)
          
          if [ "$CURRENT_RANGE" = "$NEW_RANGE" ]; then
            echo "No update needed. Current range is already: $CURRENT_RANGE"
            echo "updated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Update the file
          sed -i "s/com.redhat.openshift.versions: \".*\"/com.redhat.openshift.versions: \"$NEW_RANGE\"/" bundle/metadata/annotations.yaml
          
          echo "Updated OpenShift versions from $CURRENT_RANGE to $NEW_RANGE"
          echo "updated=true" >> $GITHUB_OUTPUT
          echo "old_range=$CURRENT_RANGE" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        if: steps.update-file.outputs.updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ”„ OpenShift Version Update Available: ${{ steps.fetch-versions.outputs.new_range }}',
              body: `## ğŸš€ OpenShift Version Update Detected
            
            The automated workflow has detected new OpenShift versions that should be supported.
            
            ### ğŸ“Š Version Changes
            - **Current range**: \`${{ steps.update-file.outputs.old_range }}\`
            - **New range**: \`${{ steps.fetch-versions.outputs.new_range }}\`
            - **Minimum version**: \`${{ steps.fetch-versions.outputs.min_version }}\`
            - **Maximum version**: \`${{ steps.fetch-versions.outputs.max_version }}\`
            
            ### ğŸ“ Required Action
            Update the OpenShift version range in \`bundle/metadata/annotations.yaml\`:
            
            \`\`\`yaml
            annotations:
              com.redhat.openshift.versions: "${{ steps.fetch-versions.outputs.new_range }}"
            \`\`\`
            
            ### âœ… Testing Checklist
            Before merging the update, please verify:
            - [ ] Version range is correct and matches latest OpenShift releases
            - [ ] Test operator deployment on minimum version (\`${{ steps.fetch-versions.outputs.min_version }}\`)
            - [ ] Test operator deployment on maximum version (\`${{ steps.fetch-versions.outputs.max_version }}\`)
            - [ ] Run bundle validation: \`operator-sdk bundle validate ./bundle\`
            - [ ] Update any related documentation
            
            ### ğŸ”— Resources
            - [OpenShift Release Notes](https://docs.openshift.com/container-platform/latest/release_notes/ocp-4-x-release-notes.html)
            - [Workflow Documentation](docs/OPENSHIFT_VERSION_AUTOMATION.md)
            
            ### ğŸ¤– Automation Details
            - **Workflow**: \`update-openshift-versions.yaml\`
            - **Triggered**: ${{ github.event_name }}
            - **Run ID**: ${{ github.run_id }}
            - **Timestamp**: ${{ github.event.repository.updated_at }}
            
            ---
            *This issue was automatically created by the OpenShift version update workflow.*`,
              labels: ['dependencies', 'openshift', 'version-update', 'automated']
            });
            
            console.log(`Created issue #${issue.data.number}`);

      - name: Summary
        run: |
          if [ "${{ steps.update-file.outputs.updated }}" = "true" ]; then
            echo "âœ… OpenShift version update detected!"
            echo "ğŸ“ GitHub issue created for review"
            echo "ğŸ”„ Old range: ${{ steps.update-file.outputs.old_range }}"
            echo "ğŸ†• New range: ${{ steps.fetch-versions.outputs.new_range }}"
            echo ""
            echo "ğŸ‘‰ Please review the issue and update bundle/metadata/annotations.yaml"
          else
            echo "â„¹ï¸ No update needed - versions are already current"
          fi
